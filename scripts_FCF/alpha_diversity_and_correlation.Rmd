---
title: "alpha_diversity_and_correlation"
output: html_notebook
---

Goal: track Alpha Diversity and Proportionality over samples and establish sample ordering

# Installation

```{r}
# devtools::install_github("tpq/propr")
# install.packages('ggdendro')
```

```{r}
# devtools::install_github("jrnold/ggthemes")
# install.packages("ggthemes") # has tableau_tableau20 color palette
```


# Loading Required Packages

```{r}
library("ggplot2"); packageVersion("ggplot2") # plotting
```
```{r}
library("tidyverse"); packageVersion("tidyverse") # util              
```
```{r}
library("dplyr"); packageVersion("dplyr") # util
```
```{r}
library("phyloseq"); packageVersion("phyloseq") # data object                 
```
```{r}
library("propr"); packageVersion("propr") # proportionality: compositional correlation
```
# Initialization

```{r}
# ggplot2 package theme set
theme_set(theme_bw())

# control randomization
set.seed(42)

# save outputs
save_location = "../data/processed_FCF_53OTUs//"
```

# Dataset Prep

## Phyloseq Object

```{r}
ps <- readRDS(paste(save_location, "phyloseq.rds", sep=""))
ps
```
## Sample Metadata as Table

```{r}
sample_meta <- as.data.frame(as.matrix(sample_data(ps)))
sample_meta$day <- as.numeric(sample_meta$day)
sample_meta$transfer <- as.numeric(sample_meta$transfer)
sample_meta$shdiv <- as.numeric(sample_meta$shdiv)
sample_meta$RC <- as.numeric(sample_meta$RC)
```

## Process Sample Metdata Table

```{r}
focused.cluster_levels <- c("early", "mid C", "late C", 
                            "perturbed G", "mid G", "late G", 
                            "perturbed M", "mid M", "late M")

focused.cluster_colors <- c("gray50", "springgreen3", "springgreen4",
                            "steelblue1", "steelblue3", "steelblue4",
                            "sienna1", "sienna3", "sienna4")
names(focused.cluster_colors) <- focused.cluster_levels

focused.cluster_shapes <- c(1, 10, 16,
                            1, 10, 16,
                            1, 10, 16)
names(focused.cluster_shapes) <- focused.cluster_levels

# for 20 color palette
tableau_20_colors <- ggthemes::ggthemes_data[["tableau"]][["color-palettes"]][["regular"]][["Tableau 20"]]$value
```

```{r}
# make C0C part of C series
sample_meta$series[1] <- "C"
# make variable to store each time point (tp)
sample_meta <- sample_meta %>%
  mutate(tp = paste(series, transfer, sprintf("%02d", day), sep="-"))
# reorder data frame
sample_meta <- sample_meta[with(sample_meta, order(series, transfer, day)),]
# make tp an ordered factor
sample_meta$tp <- factor(sample_meta$tp, levels = unique(sample_meta$tp))
# make variable to store tp_order (as numeric value)
tp_order_map <- 1:length(unique(sample_meta$tp))
names(tp_order_map) <- unique(sample_meta$tp)
sample_meta <- sample_meta %>%
  mutate(tp_order = tp_order_map[as.character(tp)])
# final sample_meta
sample_meta
```
# Alpha Diversity

## ShDiv vs. RC

```{r}
ggplot(sample_meta, aes(x=RC, y=shdiv, colour=focused.cluster)) +
  geom_point() +
  geom_vline(xintercept = 70000, linetype = "dotted") +
  geom_vline(xintercept = 120000, linetype = "dotted") +
  scale_color_manual(values=focused.cluster_colors) +
  theme_set(theme_classic()) +
  ggtitle("RC vs. ShDiv")

ggplot(sample_meta, aes(x=RC, y=shdiv, alpha=0.3)) +
  geom_point(show.legend = FALSE) +
  geom_vline(xintercept = 70000, linetype = "dotted") +
  geom_vline(xintercept = 120000, linetype = "dotted") +
  theme_set(theme_classic()) +
  ggtitle("RC vs. ShDiv")

ggplot(sample_meta, aes(x=RC, y="", alpha=0.3)) +
  geom_jitter(show.legend = FALSE, width = 0) +
  theme_set(theme_classic()) +
  ggtitle("jitter (example of no correlation)")
```
## ShDiv vs. Time Points

```{r}
sample_meta$tp
```


```{r}
sample_meta %>% 
  ggplot(aes(x=tp_order, y=shdiv)) +
    geom_smooth(method = "loess", se = FALSE, colour="red") +
    # geom_smooth(method = lm, se = FALSE, linetype = "dashed") +
    geom_vline(xintercept = 2, linetype = "dotted") +
    geom_vline(xintercept = 7, linetype = "dotted") +
    geom_vline(xintercept = 10, linetype = "dotted") +
    geom_vline(xintercept = 14, linetype = "dotted") +
    geom_vline(xintercept = 18, linetype = "dotted") +
    geom_vline(xintercept = 22, linetype = "dotted") +
    geom_vline(xintercept = 26, linetype = "dotted") +
    geom_vline(xintercept = 30, linetype = "dotted") +
    geom_point(aes(x=tp_order, y=shdiv, colour=focused.cluster)) +
    scale_color_manual(values=focused.cluster_colors) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_x_discrete(name = "time points", 
                     limits=unique(sample_meta$tp)) + 
    ggtitle("all")
```
## Mid-Band ShDiv vs. Time Points

```{r}
sample_meta %>%
  filter(RC > 70000 & RC < 120000) %>%
  ggplot(aes(x=tp_order, y=shdiv)) +
    geom_smooth(method = "loess", se = FALSE, colour="red") +
    # geom_smooth(method = lm, se = FALSE, linetype = "dashed") +
    geom_vline(xintercept = 2, linetype = "dotted") +
    geom_vline(xintercept = 7, linetype = "dotted") +
    geom_vline(xintercept = 10, linetype = "dotted") +
    geom_vline(xintercept = 14, linetype = "dotted") +
    geom_vline(xintercept = 18, linetype = "dotted") +
    geom_vline(xintercept = 22, linetype = "dotted") +
    geom_vline(xintercept = 26, linetype = "dotted") +
    geom_vline(xintercept = 30, linetype = "dotted") +
    geom_point(aes(x=tp_order, y=shdiv, colour=focused.cluster)) +
    scale_color_manual(values=focused.cluster_colors) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_x_discrete(name = "time points", 
                     limits=unique(sample_meta$tp)) + 
    ggtitle("mid-band")
```

# Correlation (propr - rho)

```{r}
ps
(ps_clr <- microbiome::transform(ps, "clr"))
```
## Calculate Proportionality, Indentify Cutoff

* Typically FDR of 0.1 means that there is a chance that 10% of the genes are not false positive i.e. if 100 genes are called DEGs then about 10 genes are false positive.
* 5% is usually a good cutoff
* I want a false discovery rate of 1% (0.01)


```{r}
counts <- t(as(otu_table(ps), "matrix"))
(pr <- propr(counts, # rows as samples, like it should be
            metric = "rho", # or "phi", "phs", "cor", "vlr"
            ivar = "clr", # or can use "iqlr" instead
            alpha = NA, # use to handle zeros
            p = 100)) # used by updateCutoffs
# Choose the largest cutoff with an acceptable FDR.
updateCutoffs(pr,
              cutoff = seq(0, 1, .05), # cutoffs at which to estimate FDR
              ncores = 1) # parallelize here
# narrow down range to find FDR ~0.05
updateCutoffs(pr,
              cutoff = seq(0.25, 0.30, .01), # cutoffs at which to estimate FDR
              ncores = 1) # parallelize here
```
## Get Cluster Propr
* identify a highly proportional transcript module that happens to show differential abundance across the experimental groups
* take an unsupervised approach by hierarchically clustering the highly proportional feature pairs based on the matrix 1−|ρp|.
* when clustering, we call two features co-clustered if they belong to the cluster after cutting the dendrogram. 

```{r}
# Parameters
CUTOFF = 0.29 # rho cutoff
N <- 12 # number of clusters
```

```{r}
# subsetting propr object to the @pairs slot
pr_best <- pr[">", CUTOFF]
pr_best@pairs
pr_best <- simplify(pr_best)
```
Look at the prism and bokeh functions for visualizing the co-clustering of proportional features. These plots share some key similarities:
* they are all “index-naive”
* they identify the feature pairs where both constituents co-cluster (with the total number of clusters toggled by k).
* they return a vector of cluster memberships for all features in the propr object.

The prism function plots the variance of the ratio of the log-ratio transformed feature pair (VLR) versus the sum of the individual variances of each log-ratio transformed feature (VLS). The ratio of the VLR to the VLS equals 1−ρ. As such, we use here seven rainbow colored lines to indicate where ρ=[.01, .05, .50, 0, 1.50, 1.95, 1.99], going from red to violet. A low VLR with a high VLS suggests that the feature pair remains in an equilibrium despite high variability among the individual features.

```{r}
pr_prism <- propr::prism(pr, k = N)
```

The bokeh function plots pairs across the individual variances of the constituent log-ratio transformed features. For clarity of visualization, this figure projects the data on a log-fold scale. Therefore, the highly variable co-clusters appear in the top-right of the figure while the lowly variable co-clusters appear in the bottom-left. Meanwhile, highly proportional pairs tend to aggregate around the y=x diagonal.

```{r}
bokeh(pr, k = N)
```




```{r}
unique(pr_prism)
```

# Get list of higly correlated OTUs

```{r}
# create new data frame of OTU cluster membership
df_c <- data.frame(pr_prism)
colnames(df_c) <- c("cluster")
df_c$cluster <- as.factor(df_c$cluster)
# create new data frame of OTU taxonomy, OTU clr
df_c_tax <- as.data.frame(as.matrix(tax_table(ps)))
df_c_clr <- as.data.frame(as(otu_table(ps_clr), "matrix"))
# merge with data frame of cluster membership
df_c <- df_c %>%
  merge(df_c_tax, by.x=0, by.y=0, all = TRUE) %>%
  column_to_rownames("Row.names") %>%
  merge(df_c_clr, by.x=0, by.y=0) %>%
  column_to_rownames("Row.names") 

# build list of valid OTUs (within-cluster pairwise rho > cutoff)
otu_c <- c()
otu_c_cluster_counts <- c()
for (x in 1:N) {
  subset_c <- rownames(filter(df_c, cluster == x))
  if ("AsIs" %in% class(subset_c)) {
    class(subset_c) <- class(subset_c)[-match("AsIs", class(subset_c))]
  }
  # get pairs with rho > cutoff AND both members in cluster n
  res_c <- getResults(pr, 
             cutoff = CUTOFF, # minimum rho value
             include = subset_c,
             or = FALSE)
  # append valid OTUs (across both Partner and Pair)
  otu_union <- union(res_c$Partner, res_c$Pair)
  otu_c_cluster_counts <- c(otu_c_cluster_counts, length(otu_union))
  otu_c <- c(otu_c, otu_union)
}

# name counts of valid OTUs per cluster
names(otu_c_cluster_counts) <- 1:N
# only keep subset of valid OTUs
df_c <- df_c[otu_c, ]
# de-index OTU column
df_c <- cbind(OTU = rownames(df_c), df_c)
rownames(df_c) <- 1:nrow(df_c)
df_c
```

```{r}
otu_c_cluster_counts
```
```{r}
length(unique(df_c$kingdom))
length(unique(df_c$phylum))
length(unique(df_c$class))
length(unique(df_c$order))
length(unique(df_c$family))
length(unique(df_c$genus))
length(unique(df_c$species))
```

### Plot, x=tp, real fit

```{r}
df_c_longer <- df_c %>%
  # pivot data so each row has x=sampleID, y=clr
  pivot_longer(phyloseq::sample_names(ps_clr),
               names_to = "sampleID",
               values_to = "clr") %>%
  # add variable series
  mutate(series = sample_meta[sampleID, "series"]) %>%
  # add variable tp
  mutate(tp = sample_meta[sampleID, "tp"]) %>%
  # add variable tp_order
  mutate(tp_order = sample_meta[sampleID, "tp_order"])
# establish that tp is an ordered factor
df_c_longer$tp <- factor(df_c_longer$tp, levels = unique(sample_meta$tp))
# reorder data frame
df_c_longer <- df_c_longer[with(df_c_longer, order(tp)),]
df_c_longer
```

```{r}
# line plot, faceted by cluster, colored by taxrank
df_c_longer %>%
  ggplot(aes(x=tp, y=clr, group=OTU, color=genus), alpha=0.3) +
    geom_line() +
    geom_vline(xintercept = "C-1-03", linetype = "dotted") +
    geom_vline(xintercept = "C-2-03", linetype = "dotted") +
    geom_vline(xintercept = "G-1-03", linetype = "dotted") +
    geom_vline(xintercept = "G-2-03", linetype = "dotted") +
    geom_vline(xintercept = "G-3-03", linetype = "dotted") +
    geom_vline(xintercept = "M-1-03", linetype = "dotted") +
    geom_vline(xintercept = "M-2-03", linetype = "dotted") +
    geom_vline(xintercept = "M-3-03", linetype = "dotted") +
    scale_colour_manual(values = tableau_20_colors) +
    guides(color=guide_legend(ncol=2)) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    ggtitle("all") +
    facet_wrap( ~ cluster)

# line plot, faceted by cluster, colored by taxrank
df_c_longer %>%
  filter(series == "C") %>%
  ggplot(aes(x=tp, y=clr, group=OTU, color=genus), alpha=0.3) +
    geom_line() +
    geom_vline(xintercept = "C-1-03", linetype = "dotted") +
    geom_vline(xintercept = "C-2-03", linetype = "dotted") +
    scale_colour_manual(values = tableau_20_colors) +
    guides(color=guide_legend(ncol=2)) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    ggtitle("cellulose series") +
    facet_wrap( ~ cluster)

# line plot, faceted by cluster, colored by taxrank
df_c_longer %>%
  filter(series == "G") %>%
  ggplot(aes(x=tp, y=clr, group=OTU, color=genus), alpha=0.3) +
    geom_line() +
    geom_vline(xintercept = "G-1-03", linetype = "dotted") +
    geom_vline(xintercept = "G-2-03", linetype = "dotted") +
    geom_vline(xintercept = "G-3-03", linetype = "dotted") +
    scale_colour_manual(values = tableau_20_colors) +
    guides(color=guide_legend(ncol=2)) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    ggtitle("glucose series") +
    facet_wrap( ~ cluster)

# line plot, faceted by cluster, colored by taxrank
df_c_longer %>%
  filter(series == "M") %>%
  ggplot(aes(x=tp, y=clr, group=OTU, color=genus), alpha=0.3) +
    geom_line() +
    geom_vline(xintercept = "M-1-03", linetype = "dotted") +
    geom_vline(xintercept = "M-2-03", linetype = "dotted") +
    geom_vline(xintercept = "M-3-03", linetype = "dotted") +
    scale_colour_manual(values = tableau_20_colors) +
    guides(color=guide_legend(ncol=2)) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    ggtitle("malate series") +
    facet_wrap( ~ cluster)
```
### Plot, x=tp_order, loess line of best fit
 * less jagged
 * loess lines require x_axis to be continuous

```{r}
tp_order_map
```


```{r}
df_c_longer %>%
  ggplot(aes(x=tp_order, y=clr, group=OTU, color=genus), alpha=0.3) +
    geom_smooth(method = "loess", se = FALSE) +
    geom_vline(xintercept = 2, linetype = "dotted") +
    geom_vline(xintercept = 7, linetype = "dotted") +
    geom_vline(xintercept = 10, linetype = "dotted") +
    geom_vline(xintercept = 14, linetype = "dotted") +
    geom_vline(xintercept = 18, linetype = "dotted") +
    geom_vline(xintercept = 22, linetype = "dotted") +
    geom_vline(xintercept = 26, linetype = "dotted") +
    geom_vline(xintercept = 30, linetype = "dotted") +
    scale_colour_manual(values = tableau_20_colors) +
    guides(color=guide_legend(ncol=2)) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_y_continuous(name = "log2 rAB", breaks=c(0, 5, 10)) +
    scale_x_discrete(name = "time points", 
                     limits=unique(df_c_longer$tp)) +
    ggtitle("all") +
    facet_wrap( ~ cluster)

df_c_longer %>%
  filter(series == "C") %>%
  ggplot(aes(x=tp_order, y=clr, group=OTU, color=genus), alpha=0.3) +
    geom_smooth(method = "loess", se = FALSE) +
    geom_vline(xintercept = 2, linetype = "dotted") +
    geom_vline(xintercept = 7, linetype = "dotted") +
    scale_colour_manual(values = tableau_20_colors) +
    guides(color=guide_legend(ncol=2)) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_y_continuous(name = "log2 rAB", breaks=c(0, 5, 10)) +
    scale_x_discrete(name = "time points", 
                     limits=1:10,
                     labels=names(tp_order_map)[1:10]) +
    ggtitle("cellulose series") +
    facet_wrap( ~ cluster)

df_c_longer %>%
  filter(series == "G") %>%
  ggplot(aes(x=tp_order, y=clr, group=OTU, color=genus), alpha=0.3) +
    geom_smooth(method = "loess", se = FALSE) +
    geom_vline(xintercept = 10, linetype = "dotted") +
    geom_vline(xintercept = 14, linetype = "dotted") +
    geom_vline(xintercept = 18, linetype = "dotted") +
    scale_colour_manual(values = tableau_20_colors) +
    guides(color=guide_legend(ncol=2)) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_y_continuous(name = "log2 rAB", breaks=c(0, 5, 10)) +
    scale_x_discrete(name = "time points", 
                     limits=11:21,
                     labels=names(tp_order_map)[11:21]) +
    ggtitle("glucose series") +
    facet_wrap( ~ cluster)

df_c_longer %>%
  filter(series == "M") %>%
  ggplot(aes(x=tp_order, y=clr, group=OTU, color=genus), alpha=0.3) +
    geom_smooth(method = "loess", se = FALSE) +
    geom_vline(xintercept = 22, linetype = "dotted") +
    geom_vline(xintercept = 26, linetype = "dotted") +
    geom_vline(xintercept = 30, linetype = "dotted") +
    scale_colour_manual(values = tableau_20_colors) +
    guides(color=guide_legend(ncol=2)) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_y_continuous(name = "log2 rAB", breaks=c(0, 5, 10)) +
    scale_x_discrete(name = "time points", 
                     limits=22:33,
                     labels=names(tp_order_map)[22:33]) +
    ggtitle("malate series") +
    facet_wrap( ~ cluster)
```

 
```{r}
df_c_longer %>%
  ggplot(aes(x=tp_order, y=clr, group=OTU, color=family), alpha=0.3) +
    geom_smooth(method = "loess", se = FALSE) +
    geom_vline(xintercept = 2, linetype = "dotted") +
    geom_vline(xintercept = 7, linetype = "dotted") +
    geom_vline(xintercept = 10, linetype = "dotted") +
    geom_vline(xintercept = 14, linetype = "dotted") +
    geom_vline(xintercept = 18, linetype = "dotted") +
    geom_vline(xintercept = 22, linetype = "dotted") +
    geom_vline(xintercept = 26, linetype = "dotted") +
    geom_vline(xintercept = 30, linetype = "dotted") +
    scale_colour_manual(values = tableau_20_colors) +
    guides(color=guide_legend(ncol=2)) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_y_continuous(name = "log2 rAB", breaks=c(0, 5, 10)) +
    scale_x_discrete(name = "time points", 
                     limits=unique(df_c_longer$tp)) +
    ggtitle("all") +
    facet_wrap( ~ cluster)

df_c_longer %>%
  filter(series == "C") %>%
  ggplot(aes(x=tp_order, y=clr, group=OTU, color=family), alpha=0.3) +
    geom_smooth(method = "loess", se = FALSE) +
    geom_vline(xintercept = 2, linetype = "dotted") +
    geom_vline(xintercept = 7, linetype = "dotted") +
    scale_colour_manual(values = tableau_20_colors) +
    guides(color=guide_legend(ncol=2)) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_y_continuous(name = "log2 rAB", breaks=c(0, 5, 10)) +
    scale_x_discrete(name = "time points", 
                     limits=1:10,
                     labels=names(tp_order_map)[1:10]) +
    ggtitle("cellulose series") +
    facet_wrap( ~ cluster)

df_c_longer %>%
  filter(series == "G") %>%
  ggplot(aes(x=tp_order, y=clr, group=OTU, color=family), alpha=0.3) +
    geom_smooth(method = "loess", se = FALSE) +
    geom_vline(xintercept = 10, linetype = "dotted") +
    geom_vline(xintercept = 14, linetype = "dotted") +
    geom_vline(xintercept = 18, linetype = "dotted") +
    scale_colour_manual(values = tableau_20_colors) +
    guides(color=guide_legend(ncol=2)) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_y_continuous(name = "log2 rAB", breaks=c(0, 5, 10)) +
    scale_x_discrete(name = "time points", 
                     limits=11:21,
                     labels=names(tp_order_map)[11:21]) +
    ggtitle("glucose series") +
    facet_wrap( ~ cluster)

df_c_longer %>%
  filter(series == "M") %>%
  ggplot(aes(x=tp_order, y=clr, group=OTU, color=family), alpha=0.3) +
    geom_smooth(method = "loess", se = FALSE) +
    geom_vline(xintercept = 22, linetype = "dotted") +
    geom_vline(xintercept = 26, linetype = "dotted") +
    geom_vline(xintercept = 30, linetype = "dotted") +
    scale_colour_manual(values = tableau_20_colors) +
    guides(color=guide_legend(ncol=2)) +
    theme_set(theme_classic()) +
    theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
    scale_y_continuous(name = "log2 rAB", breaks=c(0, 5, 10)) +
    scale_x_discrete(name = "time points", 
                     limits=22:33,
                     labels=names(tp_order_map)[22:33]) +
    ggtitle("malate series") +
    facet_wrap( ~ cluster)
```

# Save to .csv

```{r}
# save
write.csv(df_c, paste(save_location, "propr.csv", sep=""), quote = FALSE)
```





